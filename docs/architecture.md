# Cluster Management Service Architecture Design

## Overview  
This document outlines the architecture for the Cluster Lifecycle Management Service.  
The Cluster Management Service will provide everything needed for creating and monitoring a 
Kubernetes cluster and configuring it post-bootstrap for a customer.  

## Components  

#### Cluster Management Service  
A microservice developed by the CrateKube team responsible for providing 
everything needed for creating, monitoring and deleting a Kubernetes cluster and configuring it post-bootstrap. 
For direct cluster creation RKE will be used and the state files generated by RKE must be persisted for later use in EBS.
For post MVP hosted cluster creation, such as AKS, EKS, or GKE, 
the Cluster Management Service will need to be deployed along side the Cloud Management Service.  

#### Kubernetes Cluster  
Kubernetes is a portable, extensible, open-source platform for managing containerized workloads and services, 
that facilitates both declarative configuration and automation [1]. The Cluster Management Service  
is responsible for the creation, monitoring and deletion of Kubernetes clusters as well as creating the resources 
necessary for customers to utilize the cluster.  

#### RKE
Rancher Kubernetes Engine (RKE) is a CNCF-certified Kubernetes distribution that runs entirely within Docker containers. 
RKE solves the problem of installation complexity, a common issue in the Kubernetes community [2]. The Cluster Management Service 
utilizes RKE for direct cluster creation and deletion.  

#### Cloud Management Service  
A microservice developed by the CrateKube team responsible for provisioning and monitoring cloud resources and services. 
The Cluster Management Service will utilize the Cloud Management Service for hosted Kubernetes cluster creation and deletion post MVP.  

#### Policy Management Service  
A microservice developed by the CrateKube team providing compliance validation 
for all infrastructure provisioned through platform services. The Cluster Management Service will utilize 
the Policy Management Service to validate configuration.  

#### EBS  
Amazon Elastic Block Store (EBS) is an easy to use, high performance block storage service [3]. The Cluster Management Service 
utilizes EBS to store state files generated by RKE.  

## Diagrams

#### Component and Logical

![Component and Logical](https://www.plantuml.com/plantuml/img/XP4zJmCn38Rt_0gh0rl4tW5Lb4w5XOvL1pTd8el4FYM-I0ZntybnOW5qB1xyVlYHlAk6nQQSdB4bWdsQgb619nICb4aCJbGQ1m8FUysZohoxWKUD73310sCicDqvB4cVOpPVbym5lB-3y_FnS84j96gbbrQtBBwautIb8cHKlq_Fph5euyegjmEbBgwsZveulFrGjj0myO1645HUEAvM_4sHLTYqh2OFzwVPMhkF-iH_M4FIQVY5ojBqbLodnIjMWarltS2x-t0xag4_vnC0)  

<details><summary>Show UML Code</summary>
<p>
  
```
@startuml
title Cluster Management Service - Component & Logical Diagram
[cluster-mgmt-service] --> [RKE] : levrages
[RKE] --> [Kubernetes Cluster] : provision/delete
[cluster-mgmt-service] --> [policy-mgmt-service] : validate config
[cluster-mgmt-service] --> [Kubernetes Cluster] : monitor
[cluster-mgmt-service] --> [EBS] : store state
[cluster-mgmt-service] --> [cloud-mgmt-service] : invoke
database "EBS" {
}
@enduml
```
  
</p>
</details>

#### Physical

![Physical](https://www.plantuml.com/plantuml/img/jLDDRzim3BtxLwW-hK0LttiOcgGvBUiAf40FHGwqn3b2zGM9RXOC-U-bxGR94AUNRJx8C1_v-1uftsM2HAspnPNnohOQnOOevjkgIh2TD8OsRTrcJ2fuGayJ5Lm5ssoXpjrR6WQo_1cIZ1PynrGvo8IfqYPJDNrUpODpmK_Y_sloWBGDwTNuPkhrVE2uHslUCEsgnN8sZT4Q1MI2NmRGCs0IXMcGH8OiYhbjEpxn7Jmqw9X0h32z6OL2YiVDBdEz5VS6cWIkIAW8VCDrx4_yBWG_b_jy0LlVb5r474BbJVcqN8c5XzgYBgzxXlvuMSnMw-CdbmeflugNEUiBZXL-QsjC7WdpGVHQt8eKMexyMV8ZOkh5NChiZwENyhoW_33NArD3JBh6aSp3TDQdS6Zr9J06dink1DsFAld4xQcaqmfUUmfMFFA0KJm4ZQU9lOPNvf9goBETZtxNQJsIbTK6TMj7GOYcjt068YazHXPJ-BKx1omY7QFxKLEy3XJFVBTv5AEUL9SXGMjUsZ_kVLZ1f-q_aYGSh_xVwjWN--8ElUQVynq0)  

<details><summary>Show UML Code</summary>
<p>
  
```
@startuml
!include https://raw.githubusercontent.com/awslabs/aws-icons-for-plantuml/master/dist/AWSCommon.puml
!include https://raw.githubusercontent.com/awslabs/aws-icons-for-plantuml/master/dist/NetworkingAndContentDelivery/ELBApplicationLoadBalancer.puml
title Cluster Management Service - Physical Diagram
rectangle AWS {
    ELBApplicationLoadBalancer(alb,"Load Balancer","TLS Enabled")
    
    [EBS]
    
    alb --> [Customer Kubernetes Cluster] : routes
    alb --> [Operations Cluster] : routes
    
    rectangle "Operations Cluster" {
        [cluster-mgmt-service]
        [cloud-mgmt-service]
        [policy-mgmt-service]
    }
    
    rectangle "Customer Kubernetes Cluster" {
        rectangle "Control Plane Node" {
            [kube-controller-manager]
            [kube-scheduler]
            [kubeapi-server]
            [etcd]
            [kube-proxy]
            [kubleet]
        }
        rectangle "Crate Worker Node" {
            [crate-addons]
            [kube-proxy]
            [kubleet]
        }
        rectangle "Customer Worker Node" {
            [customer-applications]
            [kube-proxy]
            [kubleet]
        }
    }
}
@enduml
```
  
</p>
</details>

#### Security 

![Security](https://www.plantuml.com/plantuml/img/bP712eCm38RlVOhWtHVOOGZkDWO3Zpgagva6QojjEd1ZxpuTY8SnHc_vuSkVFqdcMJeEWnPCh15o7JoZWvCqiiK13KE1xauA8Pqh5Hpn10UIhPE3A7_ZbM7RewbbuEvnWJJTGtcscjJq7zx19bNia6EueZF8wDTbAkDzL_SutKZZuhx8iQTOvuAjcx7Ao96sgAk83ffh6vhOOwXFK_8T9O6dU8aCJJC_ymq0)  

<details><summary>Show UML Code</summary>
<p>
  
```
@startuml
title Cluster Management Service - Security Diagram
[Cluster Management Service\ntoken_authz] --> [Policy Management Service\ntoken_authz] : token_authc
[Cluster Management Service\ntoken_authz] --> [Kubernetes Cluster\nssh_keyfile] : ssh_pki
[Cluster Management Service\ntoken_authz] --> [Storage\napi_authz] : api_authc
[Cluster Management Service\ntoken_authz] --> [Cloud Management Service\ntoken_authz] : token_authc
cloud "Storage\napi_authz" {
}
@enduml
```
  
</p>
</details>
        
## References   
[1]: [What is Kubernetes](https://kubernetes.io/docs/concepts/overview/components/)     
[2]: [Overview of RKE](https://rancher.com/docs/rke/latest/en/)  
[3]: [Amazon Elastic Block Store](https://aws.amazon.com/ebs/?ebs-whats-new.sort-by=item.additionalFields.postDateTime&ebs-whats-new.sort-order=desc)
