# Cluster Management Service Architecture Design

## Overview  
This document outlines the architecture for the Cluster Lifecycle Management Service.  
The Cluster Management Service will provide everything needed for creating and monitoring a 
Kubernetes cluster and configuring it post-bootstrap for a customer.  
  
The MVP targets AWS and exposes an agnostic and asynchronous interface for provisioning, configuring and tearing down Kubernetes clusters. 
Authentication will be set at runtime using a shared token, to be superseded by more robust authentication in the future.

## Components  

#### Cluster Management Service  
A microservice developed by the CrateKube team responsible for providing 
everything needed for creating, monitoring and deleting a Kubernetes cluster and configuring it post-bootstrap. 
For direct cluster creation RKE will be used and the state files generated by RKE must be persisted for later use in EBS.
For post MVP hosted cluster creation, such as AKS, EKS, or GKE, 
the Cluster Management Service will need to be deployed along side the Cloud Management Service.  

#### Kubernetes Cluster  
Kubernetes is a portable, extensible, open-source platform for managing containerized workloads and services, 
that facilitates both declarative configuration and automation [1]. The Cluster Management Service  
is responsible for the creation, monitoring and deletion of Kubernetes clusters as well as creating the resources 
necessary for customers to utilize the cluster.  

#### RKE
Rancher Kubernetes Engine (RKE) is a CNCF-certified Kubernetes distribution that runs entirely within Docker containers. 
RKE solves the problem of installation complexity, a common issue in the Kubernetes community [2]. The Cluster Management Service 
utilizes RKE for direct cluster creation and deletion.  

#### Cloud Management Service  
A microservice developed by the CrateKube team responsible for provisioning and monitoring cloud resources and services. 
The Cluster Management Service will utilize the Cloud Management Service for hosted Kubernetes cluster creation and deletion post MVP.  

#### Policy Management Service  
A microservice developed by the CrateKube team providing compliance validation 
for all infrastructure provisioned through platform services. The Cluster Management Service will utilize 
the Policy Management Service to validate configuration.  

#### EBS  
Amazon Elastic Block Store (EBS) is an easy to use, high performance block storage service [3]. The Cluster Management Service 
utilizes EBS to store state files generated by RKE.  

## Diagrams

#### Component and Logical

![Component and Logical](https://www.plantuml.com/plantuml/img/XP8nJyCm48Nt_8fJ1xQ8dG5L2am5KT4HEboTQpZLzaNs9H92_Uyu3IL1Ie8dotxttVCxhwDYqCRPJ5ajGM6Rg1JW6JrMvCWhx2YqR0XoACJLuhkp6tYIYWrQU62i0hgiHdDA5R2Q9wpWAuEqtbutZtl8y_lBxjtl59NsS0TH9L3iDQR7vAvociSUC1HrQlQjd7xa9IeUCARs0_7QxfoT1tTRiMm-bypL5yNVlcD2OQKfbm2c4opKYrTadn9w2UQ3eWPK5WzRYtgKu7uvc-P0mPDIl4wbuup2cn2aMEeWBST4ZBSbsUuscmkpgJlCr8CJfqNBATO4D-AFNCrIvgquyPn6-f-1YS16ursJBzF__0O0)  

<details><summary>Show UML Code</summary>
<p>
  
```
@startuml
title Cluster Management Service - Component & Logical Diagram
package "Cluster Management Service" {
    [RKE] --> [RKE\nState] : stores
    [cluster-mgmt-service] --> [RKE] : invokes
    database "RKE\nState" {
    }
}
package "Policy Management Service" {
    [policy-mgmt-service]
}
package "Cloud Management Service" {
    [cloud-mgmt-service]
}
package "Container Orchestration Platform" {
    [Kubernetes Cluster]
}
[RKE] --> [Kubernetes Cluster] : provisions/deletes
[cluster-mgmt-service] -up-> [policy-mgmt-service] : validates config
[cluster-mgmt-service] --> [Kubernetes Cluster] : monitors
[cluster-mgmt-service] -up-> [cloud-mgmt-service] : invokes
@enduml
```
  
</p>
</details>

#### Physical

![Physical](https://www.plantuml.com/plantuml/img/jLHDQzj04BtxLqnrIY6o8AUIGucj20fnYwaBFOGSnjB4NhmVwkx8nXJ_zyvAZd4SsVZIkKZClddxvir83u7HSsFqu9EofMugWYLp7UwppEDck52yREPD85ywosHvM3gJuIPed8VuJ9KSXFJL-RJMQ2DJPZ0m-QnIWRFHxrdkZ75sMF-_ItuGRvnVARiOsIhlE1v9gpNvRLPCngEwrgf4LivE75PZ59AIV2U95Mk2N3UH3xwZnGKP8O0P-RKg2LAOBhT1wZKyAbnuD8DIkwQ28h-3lmEGE7_73UhvRH8py9PARfDVanaK5kUQgkHpoo0mI9iw_GhFJry2J3Moj6lUTBt0FNZNC8KMRPrOcFG1axsY63MMAsa6alFD7SDZF9STD3KBmsdeG2-GHbq_dueeGzcrM-rr7ChQixr-UOSP8rD41tQU0i01llieR-h4kUqrwkeM-LxS9UQydTDLRGlmfEasBh4NunbCNDoBRou8jxGg-LFk2Xdd60H_CEOKikkvvTmaDBroTBdF2l7xJqDU7Ktd74qtghwsFqvuFzrOi9ALouNG6LcdezsilLkh8BiVieeqyHKABj79_qA9cnt9xcZb-mgEtTmNx0OFP2lvkly1)  

<details><summary>Show UML Code</summary>
<p>
  
```
@startuml
!include https://raw.githubusercontent.com/awslabs/aws-icons-for-plantuml/master/dist/AWSCommon.puml
!include https://raw.githubusercontent.com/awslabs/aws-icons-for-plantuml/master/dist/NetworkingAndContentDelivery/ELBApplicationLoadBalancer.puml
title Cluster Management Service - Physical Diagram
cloud EC2 {
    ELBApplicationLoadBalancer(alb,"Load Balancer","TLS Enabled")
    alb -up-> [K8s Platform Cluster] : routes
    node "K8s Platform Cluster" {
        package "Cluster Management Service" {
            [cluster-mgmt-service] --> [RKE] : invokes
            [RKE] -up-> [RKE State] : stores  
        }
        package "Policy Management Service" {
            [policy-mgmt-service]
        }
        package "Cloud Management Service" {
            [cloud-mgmt-service]      
        }
        package "EBS Local Host Storage" {
            database "RKE State" {
            }
        }
        [cluster-mgmt-service] -left-> [policy-mgmt-service] : queries
        [cluster-mgmt-service] -up-> [cloud-mgmt-service] : invokes
        [RKE] --> [k8s Customer Cluster] : provisions/deletes
        [cluster-mgmt-service] --> [k8s Customer Cluster] : monitors
    }
    node "k8s Customer Cluster" {
        
    }
}
@enduml
```
  
</p>
</details>

#### Security 

![Security](https://www.plantuml.com/plantuml/img/jP9DYm8n38Rl_HLXplQ-U111Ryk2u54NAPquKwOVGvikZDB_RaPNS1Tal9XJ6nvUdf0i4wb8sLb1XYp2okP46E5BUTMWGq-mnVXZD8BabyxHq01hevgedF2XHgW-Fn9ihA9ZYEuUKC5P05UlTCT1K3qFlgDZxVGDawvn9DCDsFipXGxzGMLgJ-NxIXVnCWzIBc0tMguO3eujVcsOJAazT3WSZKKcvp3--yxybTy4Q_GmvTvVgJUeln3CvWyDFOEMg4_b_mv2hgStmD0RXfZEVJP3URYpYGsEanInH5_pILy0)  

<details><summary>Show UML Code</summary>
<p>
  
```
@startuml
title Cluster Management Service - Security Diagram
node "K8s Platform Cluster" {
    package "Cluster Management Service" {
        [cluster-mgmt-service\n{token_authz}]
    }
    [cluster-mgmt-service\n{token_authz}] --> [K8s Customer Cluster\n{ssh_keyfile}] : ssh_pki
    package "Policy Management Service" {
        [policy-mgmt-service\n{token_authz}]
    }
    [cluster-mgmt-service\n{token_authz}] --> [policy-mgmt-service\n{token_authz}] : {token_authc, https}
    package "Cloud Management Service" {
        [cloud-mgmt-service\n{token_authz}]
    }
    [cluster-mgmt-service\n{token_authz}] --> [cloud-mgmt-service\n{token_authz}] : {token_authc, https}
}
node "K8s Customer Cluster\n{ssh_keyfile}" {
}
@enduml
```
  
</p>
</details>
        
## References   
[1]: [What is Kubernetes](https://kubernetes.io/docs/concepts/overview/components/)     
[2]: [Overview of RKE](https://rancher.com/docs/rke/latest/en/)  
[3]: [Amazon Elastic Block Store](https://aws.amazon.com/ebs/?ebs-whats-new.sort-by=item.additionalFields.postDateTime&ebs-whats-new.sort-order=desc)
