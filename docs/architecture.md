# Cluster Management Service Architecture Design

## Overview  
This document outlines the architecture for the Cluster Lifecycle Management Service.  
The Cluster Management Service will provide everything needed for creating and monitoring a 
Kubernetes cluster and configuring it post-bootstrap for a customer.  

## Components  

#### Cluster Management Service  
A microservice developed by the CrateKube team responsible for providing 
everything needed for creating, monitoring and deleting a Kubernetes cluster and configuring it post-bootstrap. 
For direct cluster creation RKE will be used and the state files generated by RKE must be persisted for later use in EBS.
For post MVP hosted cluster creation, such as AKS, EKS, or GKE, 
the Cluster Management Service will need to be deployed along side the Cloud Management Service.  

#### Kubernetes Cluster  
Kubernetes is a portable, extensible, open-source platform for managing containerized workloads and services, 
that facilitates both declarative configuration and automation [1]. The Cluster Management Service  
is responsible for the creation, monitoring and deletion of Kubernetes clusters as well as creating the resources 
necessary for customers to utilize the cluster.  

#### RKE
Rancher Kubernetes Engine (RKE) is a CNCF-certified Kubernetes distribution that runs entirely within Docker containers. 
RKE solves the problem of installation complexity, a common issue in the Kubernetes community [2]. The Cluster Management Service 
utilizes RKE for direct cluster creation and deletion.  

#### Cloud Management Service  
A microservice developed by the CrateKube team responsible for provisioning and monitoring cloud resources and services. 
The Cluster Management Service will utilize the Cloud Management Service for hosted Kubernetes cluster creation and deletion post MVP.  

#### Policy Management Service  
A microservice developed by the CrateKube team providing compliance validation 
for all infrastructure provisioned through platform services. The Cluster Management Service will utilize 
the Policy Management Service to validate configuration.  

#### EBS  
Amazon Elastic Block Store (EBS) is an easy to use, high performance block storage service [3]. The Cluster Management Service 
utilizes EBS to store state files generated by RKE.  

## Diagrams

#### Component  
what are the system functions and how do they interact  

![Component](https://www.plantuml.com/plantuml/img/hLAnQWCn3Dtz5IBxqVs64aYNK0g5Z263UgSSeh8KP9yXbFvxVKs647AGq2v6-Bsd9prxcJ9w7gE4p5a8LZAcJ0vlg3XG9Csm8I_S4JImidWmdUvU60V76BRp_1qqpJDiNySFSgLC2TPQpKJ8Tz22KF6gI666SIq-6qtIWrlXnAPFFKa5xvZYtOIxuqsyXOB2FMQ2pdJFmzJEnluc-P5kh7l7nnAwM3AQSZQ_Gx-fj8fCebHBgYUUGfdRuY-oVtkIUP-sHbViaqBtIrcS9rt0L_WEIzA-VjSV)  

<details><summary>Show UML Code</summary>
<p>
  
```
@startuml
title Cluster Management Service - Component Diagram
[Cluster Management Service] --> [Kubernetes Installer] : levrages
[Kubernetes Installer] --> [Kubernetes Cluster] : provision/delete
[Cluster Management Service] --> [Policy Management Service] : validate config
[Cloud Management Service]  --> [Policy Management Service] : validate infra
[Cluster Management Service] --> [Kubernetes Cluster] : monitor
[Cluster Management Service] --> [Storage] : store state
[Cloud Management Service] --> [Storage] : store state
[Cloud Management Service] --> [Kubernetes Cluster] : provision/delete
[Cluster Management Service] --> [Cloud Management Service] : invoke
cloud "Storage" {
}
@enduml
```
  
</p>
</details>

#### Logical
what are the specific solutions used in the system  

![Logical](https://www.plantuml.com/plantuml/img/hP8nQmCn38Lt_mgHtNI_eOIccT8koHWoA3x5YDfMi7M6KlhVuykH9Gr72rqy-7rwVdfuMHIp3Z4OPGq4gp0KfGplcD1JfAImerpP4LXu4yyE0xmo-epHxDr4s-YZsZ9n1x3s6VRRpVe07GIgkHaLCrrSfSrmf9n8gToU6ybpbig59Jtr59euwtwMmExpJkcWOk0UbS19Eh4VBMJexx3VEN0wPPpDy7YDA8bLykpa-cKtegLnr4wSblsPzE_mFrJxoBjhTLJv8DEgmICMWaMBjO0lyssMbFhsVou0)  

<details><summary>Show UML Code</summary>
<p>
  
```
@startuml
title Cluster Management Service - Logical Diagram
[cluster-mgmt-service] --> [RKE] : levrages
[RKE] --> [Kubernetes Cluster] : provision/delete
[cluster-mgmt-service] --> [policy-mgmt-service] : validate config
[cloud-mgmt-service]  --> [policy-mgmt-service] : validate infra
[cluster-mgmt-service] --> [Kubernetes Cluster] : monitor
[cluster-mgmt-service] --> [EBS] : store state
[cloud-mgmt-service] --> [EBS] : store state
[cloud-mgmt-service] --> [Kubernetes Cluster] : provision/delete
[cluster-mgmt-service] --> [cloud-mgmt-service] : invoke
database "EBS" {
}
@enduml
```
  
</p>
</details>

#### Physical
where will the component be deployed  

![Physical](https://www.plantuml.com/plantuml/img/fLBBJiCm4BpdArQz-nyAXHC2AkNGGvN3OgzIgtx9tY0Yr7zdcn2fIU20yCqxuvtPMMyBO-REkuejEuATwmfJXcSCs9Adm51JVhUQGC7-r1UhqS63nJQZhp9fnj3Akxj33PyLo3a-tjTDTQbkmCrheeniOoYJm6PYw_6kVEjPbL6gcQ3OcP-059tL_GAPA-waQ_Goo5FtHZaGqqhwbXq3v-XWxp0Gl4H34sdGEqiFfKUEkteTmidDWb7qYKpdLW0cEzYS0SJQB1ka73_wUT4HyLYvh4nBf0I7cCyovigplg8AZP7G_wapHVchr3T1OKgoc77HVzIKxMqf6Fc8Nm00)  

<details><summary>Show UML Code</summary>
<p>
  
```
@startuml
title Cluster Management Service - Physical Diagram
rectangle AWS {
    [EBS]
}

rectangle "Operations Cluster" {
    [cluster-mgmt-service]
    [cloud-mgmt-service]
    [policy-mgmt-service]
}

rectangle "Customer Kubernetes Cluster" {
    rectangle "Control Plane Node" {
        [kube-controller-manager]
        [kube-scheduler]
        [kubeapi-server]
        [etcd]
        [kube-proxy]
        [kubleet]
    }
    rectangle "Crate Worker Node" {
        [crate-addons]
        [kube-proxy]
        [kubleet]
    }
    rectangle "Customer Worker Node" {
        [customer-applications]
        [kube-proxy]
        [kubleet]
    }
}
@enduml
```
  
</p>
</details>

#### Security 
authc, authz, trust relationships, and auditing  

![Security](https://www.plantuml.com/plantuml/img/jLB12e904BtlLmpU_O4E8TGjWi2ZXcphf8lhhkpE1XRzUng8H8HATPi7RzxCUpEH8sx9rugH98MmKTuHMjXppGkiKHF4Q2zI88HT9RoLrC9MyiBocYMVwQacKw7EkAVoUeGmN4DoC4gATfgyWX6AVeZn-NJNbpEM6Ddv4rgDX6u8BDNEbLc5xLagxDLxs5HogN9CndQqLFD6ZgiEO7uOlnVxd-UPMxnUJ3oRWdUB0TpOdKMey-wh7m00)  

<details><summary>Show UML Code</summary>
<p>
  
```
@startuml
title Cluster Management Service - Security Diagram
[Cluster Management Service\ntoken_authz] --> [Policy Management Service\ntoken_authz] : token_authc
[Cloud Management Service\ntoken_authz]  --> [Policy Management Service\ntoken_authz] : token_authc
[Cluster Management Service\ntoken_authz] --> [Kubernetes Cluster\nssh_keyfile] : ssh_pki
[Cluster Management Service\ntoken_authz] --> [Storage\napi_authz] : api_authc
[Cloud Management Service\ntoken_authz] --> [Storage\napi_authz] : api_authc
[Cloud Management Service\ntoken_authz] --> [Kubernetes Cluster\nssh_keyfile] : ssh_pki
[Cluster Management Service\ntoken_authz] --> [Cloud Management Service\ntoken_authz] : token_authc
cloud "Storage\napi_authz" {
}
@enduml
```
  
</p>
</details>
        
--- 
## References   
[1]: [What is Kubernetes](https://kubernetes.io/docs/concepts/overview/components/)     
[2]: [Overview of RKE](https://rancher.com/docs/rke/latest/en/)  
[3]: [Amazon Elastic Block Store](https://aws.amazon.com/ebs/?ebs-whats-new.sort-by=item.additionalFields.postDateTime&ebs-whats-new.sort-order=desc)
